steps:
# Build the docker container (by running docker build)
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/staging:$BRANCH_NAME', '.']

# Add some tags so things look a little nicer in the console
- name: 'gcr.io/cloud-builders/docker'
  args: ['tag', 'gcr.io/$PROJECT_ID/staging:$BRANCH_NAME', 'staging-$BRANCH_NAME']
# Push it to the container store.
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/$PROJECT_ID/staging:$BRANCH_NAME']
  
# Deploy it to cloud run right away. 
- name: 'gcr.io/cloud-builders/gcloud'
  args: [ 'beta', 'run', 'deploy', 
  '--region', 'us-central1', 
  '--image', 'gcr.io/$PROJECT_ID/staging:$BRANCH_NAME', 
  '--labels', 'disposeable=false', # This is just an arbitrary label. But we will use it to tell some script to NEVER delete it 
  '--allow-unauthenticated', # If this isn't set, you can't access it from the outside world
  '--platform', 'managed', 
  'staging-$BRANCH_NAME' # name the service
  ]
images:
- 'gcr.io/$PROJECT_ID/staging:$BRANCH_NAME'